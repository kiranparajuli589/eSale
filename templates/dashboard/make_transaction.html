{% extends 'dashboard/entry.html' %}
{% block script %}
    <script>
        var i = 0;
        var itemCodes = {{ item_code }};
        var itemNames = {{ item_name }};
        var customerNames = {{ customer_name }};
        var vendorNames = {{ vendor_name }};

        function autocomplete(inp, arr) {
            /*the autocomplete function takes two arguments,
            the text field element and an array of possible autocompleted values:*/
            var currentFocus;
            /*execute a function when someone writes in the text field:*/
            inp.addEventListener("input", function(e) {
                var a, b, i, val = this.value;
                /*close any already open lists of autocompleted values*/
                closeAllLists();
                if (!val) { return false;}
                currentFocus = -1;
                /*create a DIV element that will contain the items (values):*/
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                /*append the DIV element as a child of the autocomplete container:*/
                this.parentNode.appendChild(a);
                /*for each item in the array...*/
                for (i = 0; i < arr.length; i++) {
                    /*check if the item starts with the same letters as the text field value:*/
                    if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        /*create a DIV element for each matching element:*/
                        b = document.createElement("DIV");
                        /*make the matching letters bold:*/
                        b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += arr[i].substr(val.length);
                        /*insert a input field that will hold the current array item's value:*/
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        /*execute a function when someone clicks on the item value (DIV element):*/
                        b.addEventListener("click", function(e) {
                            /*insert the value for the autocomplete text field:*/
                            inp.value = this.getElementsByTagName("input")[0].value;
                            /*close the list of autocompleted values,
                            (or any other open lists of autocompleted values:*/
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });
            /*execute a function presses a key on the keyboard:*/
            inp.addEventListener("keydown", function(e) {
                var x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) {
                    /*If the arrow DOWN key is pressed,
                    increase the currentFocus variable:*/
                    currentFocus++;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode == 38) { //up
                    /*If the arrow UP key is pressed,
                    decrease the currentFocus variable:*/
                    currentFocus--;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode == 13) {
                    /*If the ENTER key is pressed, prevent the form from being submitted,*/
                    e.preventDefault();
                    if (currentFocus > -1) {
                        /*and simulate a click on the "active" item:*/
                        if (x) x[currentFocus].click();
                    }
                }
            });
            function addActive(x) {
                /*a function to classify an item as "active":*/
                if (!x) return false;
                /*start by removing the "active" class on all items:*/
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                /*add class "autocomplete-active":*/
                x[currentFocus].classList.add("autocomplete-active");
            }
            function removeActive(x) {
                /*a function to remove the "active" class from all autocomplete items:*/
                for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }
            function closeAllLists(elmnt) {
                /*close all autocomplete lists in the document,
                except the one passed as an argument:*/
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            /*execute a function when someone clicks in the document:*/
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });


        }
        {#autocomplete(document.getElementsById('test'), itemCodes);#}
        {#autocomplete(document.getElementById('NAME'), itemNames);#}
        autocomplete(document.getElementById('CUST'), customerNames);
        autocomplete(document.getElementById('VEND'), vendorNames);

        $(document).ready(function () {
            $("#VEND").parent().hide();
            $("#DT").parent().hide();
        });

        $(document).on('change', '#t_type', function () {
           console.log();
           if ($(this).val()== 3){
               $("#VEND").parent().show();
               $("#CUST").parent().show();
               $("#duplicater").hide();
               $("#DISCAMT").parent().hide();
               $("#DISCPER").parent().hide();
               $("#VATPER").parent().hide();
               $("#TOT").parent().hide();
               $("#TOTA").parent().hide();
               $("#TOTR").parent().hide();
               $("#p_type").hide();
               $("#DT").parent().show();
           }
           else if($(this).val()==1){
               $("#VEND").parent().hide();
               $("#duplicater").show();
               $("#DISCAMT").parent().show();
               $("#DISCPER").parent().show();
               $("#VATPER").parent().show();
               $("#TOT").parent().show();
               $("#TOTA").parent().show();
               $("#TOTR").parent().show();
               $("#p_type").show();
               $("#DT").parent().hide();
           }
           else if ($(this).val()==2){
               $("#CUST").parent().hide();
               $("#VEND").parent().show();
               $("#duplicater").show();
               $("#DISCAMT").parent().show();
               $("#DISCPER").parent().show();
               $("#VATPER").parent().show();
               $("#TOT").parent().show();
               $("#TOTA").parent().show();
               $("#TOTR").parent().show();
               $("#p_type").show();
               $("#DT").parent().hide();
           }
        });

        $(document).on('click', '.clickToClone', function () {
            var cloned = $("#duplicater").clone();
            cloned.attr("id", "duplicater"+ ++i);
            cloned.find(".test0").val("");
            cloned.find(".test").val("");
            cloned.find("#aQTY").val("");
            cloned.find("#NAME").val("");
            cloned.find("#tot1").val("");
            cloned.find("#UP").val("");
            cloned.appendTo($("#duplicater").parent());
        });
        function remove(id) {
            if (id != 'duplicater') {
                document.getElementById(id).remove();
            }
        }


        $(document).on('change','.test', function () {
            var itemId = $(this).val();
            var id = $(this).parent().parent().attr("id");
            $.ajax({
                url: '{% url 'ajax-id' %}',
                data: {
                    'item_id': itemId
                },
                dataType: 'json',
                success: function (data) {
                    $("#"+id).find('#NAME').val(data.itemName);
                    $("#"+id).find('#aQTY').val(data.itemQty);
                    if ($("#t_type").val() == 1){
                        $("#"+id).find('#UP').val(data.itemSaleRate);
                    }
                    else if ($("#t_type").val() == 2){
                        $("#"+id).find('#UP').val(data.itemBuyRate);
                    }
                }
            });
        });
        $(document).on('change', '.test0', function () {
            var qty = $(this).val();
            var id = ($(this).parent().parent().attr("id"));
            var itemId = $("#"+id).find('.test').val();
            var qtyArry = ($(".test0").serializeArray());
            var tType = $("#t_type").val();
            let sum=0;
            for (i=0; i<qtyArry.length; i++){
                sum += parseInt(qtyArry[i].value);
                $("#TOT").val(sum);
            }
            $.ajax({
                url: '{% url 'ajax-qty' %}',
                data: {
                    'item_id': itemId,
                    'item_qty': qty,
                    't_type': tType,
                },
                dataType: 'json',
                success: function (data) {
                    $("#"+id).find('#tot1').val(data.itemTotal);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        });
        $(document).on('blur', '.test1', function () {
            var amtArry = $(".test1").serializeArray();
            let sum=0;
            for (i=0; i<amtArry.length; i++){
                sum += parseInt(amtArry[i].value);
                $("#TOTA").val(sum);
                $("#TOTR").val(sum);
            }
        });
        $(document).on('change', '#DISCPER', function () {
            $("#DISCAMT").val(0);
            var discPer = parseInt($("#DISCPER").val());
            var totAmt = parseFloat($('#TOTA').val());
            var newAmt = totAmt-(discPer/100)*totAmt;
            $("#TOTR").val(newAmt);
        });
        $(document).on('change', '#DISCAMT', function () {
            $("#DISCPER").val(0);
            var discAmt = parseInt($("#DISCAMT").val());
            var totAmt = parseFloat($('#TOTA').val());
            var newAmt = totAmt-discAmt;
            $("#TOTR").val(newAmt);
        });
        $(document).on('change', '#CUST', function(){
            $("#VEND").val("");
            customer = $("#CUST").val();
            $.ajax({
                type: 'POST',
                url: '{% url 'ajax-due' %}',
                data: {
                    'customer': customer,
                    'csrfmiddlewaretoken': $("input[name=csrfmiddlewaretoken]").val()
                },
                dataType: 'json',
                success: function (data) {
                    $("#DT").val(data.customerDue);

                }
            });
        })
        $(document).on('change', '#VEND', function(){
            $("#CUST").val("");
        })
        $(document).on('click', '#submit', function () {
            {#var itemData = $("#duplicater").parent().find('.test').serializeArray();#}
            var formData = $(".transaction-entry-form").serializeArray();
            {#console.log(itemData);#}
            $.ajax({
                type: "POST",
                url: '{% url 'form-collect' %}',
                data: {
                    'form_data': formData,
                    'tot_items': $("#TOT").val(),
                    'tot_rendered': $("#TOTR").val(),
                    'tot_amt': $("#TOTA").val(),
                    'csrfmiddlewaretoken': $("input[name=csrfmiddlewaretoken]").val()
                },
                dataType: 'json',
                success: function (data) {
                  {#$(".transaction-entry-form").trigger("reset");#}
                  console.log(data.message);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        });

    </script>
{% endblock %}

{% block content %}
    <div class="card">
        <div class="header" style="font-size: xx-large">Entry</div>
        <div class="content">
            <form class="transaction-entry-form" method="POST" autocomplete="off">
                {% csrf_token %}
                <select name="transac_type" id="t_type" style="width: 13.5%; height: 2.5em; background-color: lightblue; margin-bottom: 20px      ">
                    <option value="1">SALES</option>
                    <option value="2">PURCHASE</option>
                    <option value="3">PAY DUE</option>
                </select>
                <div>
                    <div id="duplicater" class="form-group autocomplete" style="">
                        <a class="pull-right clickToClone">
                            <i class="pe-7s-angle-down-circle text-primary" style="font-size: xx-large"></i>
                        </a>
                        <a class="pull-right"
                           onclick="remove(this.parentNode.id)">
                            <i class="pe-7s-angle-up-circle text-danger" style="font-size: xx-large;"></i>
                        </a>

                        <label>Item Code<input class="test w3-input w3-border w3-light-blue" type="text" required name="id"></label>
                        <label>Item Name<input id="NAME" class="w3-input w3-border w3-light-blue" type="text" required name="name"></label>
                        <label>Available Quantity<input id="aQTY" class="w3-input w3-border w3-light-blue" type="text" disabled></label>
                        <label>Unit Price<input id="UP" class="w3-input w3-border w3-light-blue" type="text" disabled></label>
                        <label>QTY<input class="test0 w3-input w3-border w3-light-blue" type="number" required name="qty" min="{{ 1 }}"></label>
                        <label>Total<input id="tot1" class="test1 w3-input w3-border w3-light-blue" type="number" name="tot1"></label>

                    </div>
                </div>
                <div id="tala" class="from-group autocomplete">
                    <label>Discount Amt<input id="DISCAMT" class="w3-input w3-hover-light-blue" type="text" name="disc_amt"></label>
                    <label>Discount Per<input id="DISCPER" type="text" class="w3-input w3-hover-light-blue" name="disc_per"></label>
                    <label>VAT Per<input id="VATPER" type="text" class="w3-input w3-hover-light-blue" disabled name="vat_per"></label>
                    <label>Total Items<input id="TOT" type="text" class="w3-input w3-hover-light-blue" disabled name="totl_items"></label>
                    <label>Total Amount<input id="TOTA" type="text" class="w3-input w3-hover-light-blue" disabled name="totl_amt"></label>
                    <label>Total Rendered<input id="TOTR" type="text" class="w3-input w3-hover-light-blue" disabled name="totl_rend"></label>
                    <br>
                    <label>Customer<input id="CUST" class="w3-input w3-hover-light-blue" type="text" name="customer"></label>
                    <label>Vendor<input id="VEND" class="w3-input w3-hover-light-blue" type="text" name="vendor"></label>
                    <label>RESIDUE<input id="DT" type="text" class="w3-input w3-hover-light-blue" disabled name="dt"></label>
                    <select name="payment_type" id="p_type" style="width: 13.5%; height: 2.5em">
                        <option value="1">CASH</option>
                        <option value="2">CREDIT</option>
                    </select>


                    <label>Payment AMT<input class="w3-input w3-hover-light-blue" type="text" required name="p_amt"></label>

                </div>
                <div class="form-group text-center">
                    <button class="btn btn-primary btn-lg btn-fill text-center" id="submit">
                        Create Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}